Matrix completion as semi-supervised regression
========================================================

Prediction using glmnet and softImpute
```{r}
library(magrittr, quietly=TRUE, warn.conflicts=FALSE)
library(pracma, quietly=TRUE, warn.conflicts=FALSE)
library(Matrix, quietly=TRUE, warn.conflicts=FALSE, verbose=FALSE)
library(foreach, quietly=TRUE, warn.conflicts=FALSE, verbose=FALSE)
library(glmnet, quietly=TRUE, warn.conflicts=FALSE, verbose=FALSE)
library(softImpute, quietly=TRUE, warn.conflicts=FALSE)
```

# Potential outcomes model

The model is as follows.  $x_i$ are covariates of the $i$th subject, $d_i$ is a binary variable indicating treatment or control.  This is observational data, so $d_i$ depends on $x_i$.  We model
\[
\text{Pr}[D_i = 1] = \frac{e^{x_i^T \beta}}{1 + e^{x_i^T \beta}}
\]

Generate a low-rank matrix $(Y^0 Y^1 X)$.  Then determine $D$, the treatment assignment, as a function of $X$, by the above equation.  $Y^0$ is observed for all cases where $D = 0$ and $Y^1$ is observed for all cases $D = 1$.

```{r}
n <- 10000
p <- 20
k <- 1
sigma <- 0.1
full<- randn(n, k) %*% randn(k, p) + sigma * randn(n, p)
full[, 3] <- 1 # intercept term
full[, 2] <- full[, 2] + rnorm(1) # treatment effect
colnames(full) <- c("y0", "y1", "int", paste0("X", 1:(p-3)))
bt <- rnorm(p - 2) # variable determining treatment
probs <- full[, -(1:2)] %*% bt %>% {exp(.) / (1 + exp(.))}
treat <- rbinom(n=n, size=1, prob=probs)
obs <- full
obs[treat == 1, 1] <- NA
obs[treat == 0, 2] <- NA
y0 <- full[, 1]
y1 <- full[, 2]
X <- cbind(treat, full[, -c(1:3)])
y_obs <- ifelse(treat == 0, y0, y1)
```

True average treatment effect $\E[Y^1 - Y^0]$
```{r}
(true_effect <- mean(y1) - mean(y0))
```

Naive regression
```{r}
res <- lm(y_obs ~ X)
(naive_effect <- coef(res)[2])
```

Alternating regression
```{r}
cases0 <- cbind(y_obs, X[, -1])[treat == 0, ]
cases1 <- cbind(y_obs, X[, -1])[treat == 1, ]
res0 <- lm(cases0[, 1] ~ cases0[, -1])
res1 <- lm(cases1[, 1] ~ cases1[, -1])
yh0 <- coef(res0) %>% {.[1] + cases1[, -1] %*% .[-1]}
yh1 <- coef(res1) %>% {.[1] + cases0[, -1] %*% .[-1]}
(alt_effect <- mean(c(yh1, cases1[, 1]) - c(cases0[, 1], yh0)))
```

Matrix completion
```{r}
obs2 <- obs[, -3] # remove intercept column
fit <- softImpute(obs2, rank.max=k, type="als")
pre <- complete(obs2, fit)
(mc_effect <- mean(pre[, 2] - pre[, 1]))
```

